---
title: 新东西引入套路
date: 2019-06-05 
tags: unit test
categories: unit test
---

[TOC]

# 单元测试方案

## 1.不依赖设备的单元测试

### 简介

使用Robolectric和mockito（power mockito ），其中Robolectric主要是模拟android设备环境，即不需要启动android设备，即可以正常运行还有android sdk的代码，如activity，application，service等。mockito主要用来模拟对象的响应，例如list的size()让他返回100。

### 参考资料：

[Robolectric官网介绍](http://robolectric.org/configuring/)

[mockito官网例子](http://static.javadoc.io/org.mockito/mockito-core/2.9.0/org/mockito/Mockito.html)

### 例子

#### gradle导入

其中Powermockito可处理静态，私有，final的类或变量，后续基本用这个

```
android.testOptions {
    unitTests.includeAndroidResources = true
}
dependencies {
    //junit 
    testCompile 'junit:junit:4.12'
    //robolectric 版本（sdk23需导入opengl-apk）
    testCompile "org.robolectric:robolectric:3.8"
    testCompile 'org.khronos:opengl-api:gl1.1-android-2.1_r1'

    //mockito
     testCompile "org.mockito:mockito-core:2.8.9"
    //androidTestCompile "org.mockito:mockito-android:2.8.9"

    //powermockito  这个要和mockito一一对应
    testCompile "org.powermock:powermock-module-junit4:1.7.3"
    testCompile "org.powermock:powermock-module-junit4-rule:1.7.3"
    testCompile "org.powermock:powermock-api-mockito2:1.7.3" //注意这里是mockito2
    testCompile "org.powermock:powermock-classloading-xstream:1.7.3"
}
```

####  代码

##### P测试

1.先编写Robolectri，Powermock标签

2.setup设置mock的对象（有些需要反射）

3.对函数进行分支测试

原始代码

```
public class ReissuePresenter implements ReissueContract.Presenter {
    private ReissueContract.Model mModle = new ReissueModel();
    private ReissueContract.View mView;

    public ReissuePresenter(ReissueContract.View mView) {
        this.mView = mView;
    }


    @Override
    public void reisuueNotice(String serverPath, QueryReqInfo orderInfo) {
        String url = serverPath + "/icp/OFRTZBPA/751504.dow" + Properity2Param.getParams(orderInfo);
        mModle.reissueNotice(url, new IHttpRequestListener<JSONObject>() {
            @Override
            public void onSuccess(JSONObject result, Response response) {
                String resultcode = result.optString("RESULT");
                if ("00".equals(resultcode)) {
                    mView.reissueSuccess();
                } else {
                    mView.onFailResponse(Constant.ERROR_2, result.optString("RSPMSG"));
                }
            }

            @Override
            public void onFail(int errCode, String errMsg) {
                if (Constant.ERROR_2 == errCode) {
                    errMsg = Constant.ERROR_REISUEENOTICE;
                }
                mView.onFailResponse(errCode, errMsg);
            }
        });
    }

    @Override
    public void checkPayStatus(String serverPath, QueryReqInfo query) {
        LogUtils.i("checkPayStatus");
        String url = serverPath + "/icp/OFRTZBPA/751503.dow" + Properity2Param.getParams(query);
        mModle.checkPayStatus(url, new IHttpRequestListener<JSONObject>() {
            @Override
            public void onSuccess(JSONObject result, Response response) {

                QueryResultRespInfo respInfo = new QueryResultRespInfo();
                respInfo.setResult(result.optString("RESULT") );
                respInfo.setOrderId(result.optString("ORDERID"));
                respInfo.setiOrdList(result.optString("IORDLIST"));
                respInfo.setCustNam(result.optString("CUSTNAM"));
                respInfo.setOrderAmt(result.optString("ORDERAMT"));
                respInfo.setNoticeStatus(result.optString("NOTICESTATUS"));
                String GWA = result.optString("GWA");
                try {
                    JSONObject jsonObj1 = new JSONObject(GWA);
                    respInfo.setMsgData(jsonObj1.optString("MSG_DAT"));
                } catch (JSONException e) {
                    e.printStackTrace();
                }

                mView.checkPayStatusSuccess(respInfo);
            }

            @Override
            public void onFail(int errCode, String errMsg) {
                mView.onFailResponse(errCode, errMsg);
            }
        });
    }
}
```

测试代码

```
//设置Robolectric模拟的android设备类（Powermock专用）
@RunWith(RobolectricTestRunner.class)
@Config(constants = BuildConfig.class)
//Powermock设置对象
@PrepareForTest(Response.class)
//Powermock忽略一些对象
@PowerMockIgnore({"org.powermock.*", "org.mockito.*", "org.robolectric.*",
        "android.*", "androidx.*", "javax.xml.*", "org.xml.sax.*", "org.w3c.dom.*",
        "org.springframework.context.*", "org.apache.log4j.*", "org.bouncycastle.*"})
public class ReissuePresenterTest {
    private ReissueContract.Presenter mPresenter;
    private ReissueContract.Model mModel;
    private ReissueContract.View mView;

    /**
     * Powermock的rule
     */
    @Rule
    public PowerMockRule rule = new PowerMockRule();

    /**
     * @throws Exception
     * 必要的初始化
     */
    @Before
    public void setup() throws Exception {
        LogUtils.isSaveLog = false;
        mModel = PowerMockito.mock(ReissueContract.Model.class);
        mView = PowerMockito.mock(ReissueContract.View.class);
        mPresenter = new ReissuePresenter(mView);
        Field fieldModel = mPresenter.getClass().getDeclaredField("mModle");
        fieldModel.setAccessible(true);
        fieldModel.set(mPresenter, mModel);

    }

    @Test
    public void reisuueNotice() throws JSONException {
        QueryReqInfo orderInfo = new QueryReqInfo();
        JSONObject jsonObject = new JSONObject();
        ArgumentCaptor<IHttpRequestListener<JSONObject>> callback = ArgumentCaptor.forClass(IHttpRequestListener.class);

        //1成功分支 00
        mPresenter.reisuueNotice("Test", orderInfo);
        verify(mModel).reissueNotice(anyString(), callback.capture());
        jsonObject.put("RESULT", "00");
        callback.getValue().onSuccess(jsonObject, PowerMockito.mock(Response.class));
        verify(mView).reissueSuccess();

        //2成功分支 不是00
        mPresenter.reisuueNotice("Test", orderInfo);
        jsonObject.put("RESULT", "01");
        jsonObject.put("RSPMSG", "01");
        callback.getValue().onSuccess(jsonObject, PowerMockito.mock(Response.class));
        verify(mView).onFailResponse(Constant.ERROR_2, "01");

        //3失败分支  errmsg不是Constant.ERROR_2
        mPresenter.reisuueNotice("Test", orderInfo);
        callback.getValue().onFail(0,"测试1");
        verify(mView).onFailResponse(0,"测试1");

        //4失败分支  errmsg是Constant.ERROR_2
        mPresenter.reisuueNotice("Test", orderInfo);
        callback.getValue().onFail(2,"测试1");
        verify(mView).onFailResponse(2,"通知失败，请再次补发通知");
    }

    @Test
    public void checkPayStatus() throws JSONException {
        QueryReqInfo orderInfo = new QueryReqInfo();
        JSONObject jsonObject = new JSONObject();
        ArgumentCaptor<IHttpRequestListener<JSONObject>> callback = ArgumentCaptor.forClass(IHttpRequestListener.class);

        //1失败分支
        mPresenter.checkPayStatus("Test", orderInfo);
        verify(mModel).checkPayStatus(anyString(), callback.capture());
        callback.getValue().onFail(0,"测试1");
        verify(mView).onFailResponse(0,"测试1");

        //2成功分支
        mPresenter.checkPayStatus("Test", orderInfo);
        jsonObject.put("RESULT", "00");
        jsonObject.put("ORDERID", "00");
        jsonObject.put("IORDLIST", "00");
        jsonObject.put("CUSTNAM", "00");
        jsonObject.put("ORDERAMT", "00");
        jsonObject.put("NOTICESTATUS", "00");
        JSONObject childJsonObject = new JSONObject();
        childJsonObject.put("MSG_DAT", "00");
        jsonObject.put("GWA", childJsonObject);
        callback.getValue().onSuccess(jsonObject,PowerMockito.mock(Response.class));
        ArgumentCaptor<QueryResultRespInfo> respInfoCallback = ArgumentCaptor.forClass(QueryResultRespInfo.class);
        verify(mView).checkPayStatusSuccess(respInfoCallback.capture());
        Assert.assertEquals(respInfoCallback.getValue().getOrderId(),"00");
        Assert.assertEquals(respInfoCallback.getValue().getResult(),"00");
        Assert.assertEquals(respInfoCallback.getValue().getiOrdList(),"00");
        Assert.assertEquals(respInfoCallback.getValue().getCustNam(),"00");
        Assert.assertEquals(respInfoCallback.getValue().getOrderAmt(),"00");
        Assert.assertEquals(respInfoCallback.getValue().getNoticeStatus(),"00");
        Assert.assertEquals(respInfoCallback.getValue().getMsgData(),"00");
    }
}
```

##### V测试

acivitiy的代码：

```
public class ReissueAcitivity extends BaseActivity implements ReissueContract.View {
	@Override
    public void checkPayStatusSuccess(QueryResultRespInfo resultRespInfo) {

        dismissDialog();
        String result = resultRespInfo.getResult();
        LogUtils.i(" result:" + result);

        if (UIConstant.RESPONSE_SUCCESS.equals(result)) {
            String noticeStatus = resultRespInfo.getNoticeStatus();
            if (UIConstant.RESPONSE_SUCCESS.equals(noticeStatus)) {
                noticeSuccess(getString(R.string.reissue_success));
            } else {
                if (mSecondTime) {
                    noticeSuccess(getString(R.string.reissue_err));
                }
            }
        } else {
            String msg = GlobalData.noticRespCode.get(result);
            if (StringUtil.isEmpty(msg) || StringUtil.isEmpty(resultRespInfo.getMsgData())) {
                msg = "未知错误";
            } else {
                msg = resultRespInfo.getMsgData();
            }
            toastOnUI(msg);
            if (mSecondTime) {
                ReissueAcitivity.this.finish();
            }
        }
    }
}
```

测试代码:

```
//设置Robolectric模拟的android设备类（Powermock专用）
@RunWith(RobolectricTestRunner.class)
@Config(constants = BuildConfig.class, sdk = 23)
public class ReissueActivityTest {

    public ActivityController<ReissueAcitivity> activityController;
    /**
     * @throws Exception
     * 必要的初始化
     */
    @Before
    public void setup() throws Exception {

        Intent intent = new Intent();
        intent.putExtra("test", "HelloWorld");
        activityController = Robolectric.buildActivity(ReissueAcitivity.class).newIntent(intent);
    }

    @Test
    public void test1() throws Exception {
        ReissueAcitivity activity = Robolectric.setupActivity(ReissueAcitivity.class);
        QueryResultRespInfo queryResultRespInfo = new QueryResultRespInfo();
        queryResultRespInfo.setResult("00");
        queryResultRespInfo.setNoticeStatus("00");
        activity.checkPayStatusSuccess(queryResultRespInfo);
        assertEquals(activity.getString(R.string.reissue_success), ((TextView)ShadowDialog.getLatestDialog()
                .findViewById(R.id.dialog_tip_content)).getText());
        assertNotNull((ShadowDialog.getLatestDialog()));

        queryResultRespInfo.setNoticeStatus("01");
        activity.checkPayStatusSuccess(queryResultRespInfo);
        assertNull((ShadowAlertDialog.getLatestAlertDialog()));

        queryResultRespInfo.setResult("01");
        activity.checkPayStatusSuccess(queryResultRespInfo);
        assertEquals("未知错误",ShadowToast.getTextOfLatestToast());

        Field field = activity.getClass().getDeclaredField("mSecondTime");
        field.setAccessible(true);
        field.set(activity, true);

        queryResultRespInfo.setResult("00");
        queryResultRespInfo.setNoticeStatus("01");
        activity.checkPayStatusSuccess(queryResultRespInfo);
        assertEquals(activity.getString(R.string.reissue_err), ((TextView)ShadowDialog.getLatestDialog()
                .findViewById(R.id.dialog_tip_content)).getText());
        assertNotNull((ShadowDialog.getLatestDialog()));

        queryResultRespInfo.setResult("01");
        queryResultRespInfo.setMsgData("测试1");
        activity.checkPayStatusSuccess(queryResultRespInfo);
        assertEquals(false,activity.isFinishing());
    }
}
```



## 2.依赖设备的测试

### 简介

采用的是expresso（跨进程使用UI Automator）和FakeNetDataCenter（自己写的假数据中心），expresso用法简单，由google自研，搭配android studio的Record Expresso Test功能则可以快速构建想要的测试案例。FakeNetDataCenter 可以自己编写，返回数据可进行设置xml，json，webp等，前提是应用需要统一使用NetDataCenter来获取网络数据。

### 参考资料：

[expresso官方教程](https://developer.android.com/training/testing/espresso)

### 例子

####  gradle导入

```
android {
    defaultConfig {
        testInstrumentationRunner "android.support.test.runner.AndroidJUnitRunner"
       }
    }
    packagingOptions {
        exclude 'LICENSE.txt'
    }
}
configurations.all {
    resolutionStrategy.force 'com.android.support:support-annotations:27.1.1'
}

dependencies {
    androidTestCompile 'com.android.support.test:runner:1.0.2'
    // Set this dependency to use JUnit 4 rules
    androidTestCompile 'com.android.support.test:rules:1.0.2'

    //espresso
    androidTestCompile 'com.android.support.test.espresso:espresso-core:3.0.2'
    //espresso导入idlingResource(代码和测试有关联)
    compile "com.android.support.test.espresso:espresso-idling-resource:3.0.2"
    androidTestCompile "com.android.support.test.espresso:espresso-idling-resource:3.0.2"
}
```

#### 代码

原始核心代码

view:

```
public class ReissueAcitivity extends BaseActivity implements ReissueContract.View {
	@Override
    protected void initComponent() {
       
        btnNext = (Button) findViewById(R.id.bt_reissue);
        btnNext.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                showDialog("正在补单...");
                mSecondTime = true;
                mPresenter.reisuueNotice(BuildConfig.URL_SERVER, Utils.getQueryPayInfoReq(mOrderId));
            }
        });
    }
    
    @Override
    public void reissueSuccess() {
        LogUtils.i("reissueSuccess");
        runOnUiThread(new Runnable() {
            @Override
            public void run() {
                startTimer();
            }
        });
    }
    
     private void startTimer() {
        if (mCountDownTimer == null) {
            long time = 20 * 1000;
//            if (mSecondTime) {
//                time = 20 * 1000;
//            }
            mCountDownTimer = new CountDownTimer(time, 1000) {
                @Override
                public void onTick(long l) {

                    if (mSecondTime) {
                        showDialog(String.format(getResources().getString(R.string.reissue_dialog), l / 1000));
                    } else {
                        String timer = String.format(getResources().getString(R.string.reissue_timer), l / 1000);
                        tvToast.setText(timer);
                        btnNext.setEnabled(false);
                    }
                }

                @Override
                public void onFinish() {
                    if (!mSecondTime) {
                        btnNext.setEnabled(true);
                        menuEnable = true;
                        if (TextUtils.isEmpty(GlobalData.sn) || TextUtils.isEmpty(GlobalData.merchantNo)) {
                            showToast("商户号或终端号获取失败，请重试");
                            bindAuthorizor();
                            return;
                        }
                        tvToast.setVisibility(View.INVISIBLE);
                    }
                    showDialog("正在查询通知状态");
                    mPresenter.checkPayStatus(BuildConfig.URL_SERVER, Utils.getQueryPayInfoReq(mOrderId));
                    mCountDownTimer = null;
                }
            };
        }
        menuEnable = false;
        tvToast.setVisibility(View.VISIBLE);
        mCountDownTimer.start();
    }
}
```

P:

```
public class ReissuePresenter implements ReissueContract.Presenter {
    private ReissueContract.Model mModle = new ReissueModel();
    private ReissueContract.View mView;

    public ReissuePresenter(ReissueContract.View mView) {
        this.mView = mView;
    }


    @Override
    public void reisuueNotice(String serverPath, QueryReqInfo orderInfo) {
        String url = serverPath + "/icp/OFRTZBPA/751504.dow" + Properity2Param.getParams(orderInfo);
        mModle.reissueNotice(url, new IHttpRequestListener<JSONObject>() {
            @Override
            public void onSuccess(JSONObject result, Response response) {
                String resultcode = result.optString("RESULT");
                if ("00".equals(resultcode)) {
                    mView.reissueSuccess();
                } else {
                    mView.onFailResponse(Constant.ERROR_2, result.optString("RSPMSG"));
                }
            }

            @Override
            public void onFail(int errCode, String errMsg) {
                if (Constant.ERROR_2 == errCode) {
                    errMsg = Constant.ERROR_REISUEENOTICE;
                }
                mView.onFailResponse(errCode, errMsg);
            }
        });
    }

    @Override
    public void checkPayStatus(String serverPath, QueryReqInfo query) {
        LogUtils.i("checkPayStatus");
        String url = serverPath + "/icp/OFRTZBPA/751503.dow" + Properity2Param.getParams(query);
        mModle.checkPayStatus(url, new IHttpRequestListener<JSONObject>() {
            @Override
            public void onSuccess(JSONObject result, Response response) {

                QueryResultRespInfo respInfo = new QueryResultRespInfo();
                respInfo.setResult(result.optString("RESULT"));
                respInfo.setOrderId(result.optString("ORDERID"));
                respInfo.setiOrdList(result.optString("IORDLIST"));
                respInfo.setCustNam(result.optString("CUSTNAM"));
                respInfo.setOrderAmt(result.optString("ORDERAMT"));
                respInfo.setNoticeStatus(result.optString("NOTICESTATUS"));
                String GWA = result.optString("GWA");
                try {
                    JSONObject jsonObj1 = new JSONObject(GWA);
                    respInfo.setMsgData(jsonObj1.optString("MSG_DAT"));
                } catch (JSONException e) {
                    e.printStackTrace();
                }

                mView.checkPayStatusSuccess(respInfo);
            }

            @Override
            public void onFail(int errCode, String errMsg) {
                mView.onFailResponse(errCode, errMsg);
            }
        });
    }
    
    @Override
    public void checkPayStatusSuccess(QueryResultRespInfo resultRespInfo) {

        dismissDialog();
        String result = resultRespInfo.getResult();
        LogUtils.i(" result:" + result);

        if (UIConstant.RESPONSE_SUCCESS.equals(result)) {
            String noticeStatus = resultRespInfo.getNoticeStatus();
            if (UIConstant.RESPONSE_SUCCESS.equals(noticeStatus)) {
                noticeSuccess(getString(R.string.reissue_success));
            } else {
                if (mSecondTime) {
                    noticeSuccess(getString(R.string.reissue_err));
                }
            }
        } else {
            String msg = GlobalData.noticRespCode.get(result);
            if (StringUtil.isEmpty(msg) || StringUtil.isEmpty(resultRespInfo.getMsgData())) {
                msg = "未知错误";
            } else {
                msg = resultRespInfo.getMsgData();
            }
            toastOnUI(msg);
            if (mSecondTime) {
                ReissueAcitivity.this.finish();
            }
        }


    }
    
     private void noticeSuccess(final String msg) {
        runOnUiThread(new Runnable() {
            @Override
            public void run() {
                DialogFactory.showMessage(ReissueAcitivity.this, "出单结果", msg, "确定", new View.OnClickListener() {
                    @Override
                    public void onClick(View v) {
                        DialogFactory.dismissAlert(ReissueAcitivity.this);
                        ReissueAcitivity.this.finish();
                    }
                });
            }
        });
    }
}
```

M:

```
public class ReissueModel implements ReissueContract.Model {

    @Override
    public void reissueNotice(String serverAddress, IHttpRequestListener<JSONObject> httpRequestListener) {
        OkHttpBase.getInstantce().executeSipsGet(serverAddress
                , httpRequestListener);
    }

    @Override
    public void checkPayStatus(String url, IHttpRequestListener<JSONObject> httpRequestListener) {
        OkHttpBase.getInstantce().executeSipsGet(url,
                httpRequestListener);
    }
}
```

FakeData(保险app修改的为OkHttpBase,下面为部分代码)

```
public class OkHttpBase<T> {

    private final static int TIMEOUT = 10;
    private volatile static OkHttpBase mOkHttpBase;
    private OkHttpClient client;
    private static boolean isFake = false;

    public static final int RESPONSE_SUCCESS = 0;

    public static void setFake(boolean fake) {
        isFake = fake;
    }

    private OkHttpBase() {
        if (isFake) {
            client = new OkHttpClient.Builder().connectTimeout(TIMEOUT, TimeUnit.SECONDS)
                    .readTimeout(TIMEOUT, TimeUnit.SECONDS).writeTimeout(TIMEOUT, TimeUnit.SECONDS)
                    .sslSocketFactory(SSLSocketUtils.createSSLSocketFactory())
                    .hostnameVerifier(SSLSocketUtils.creatHostnameVerifier())
                    .addInterceptor(new Interceptor() {
                        @Override
                        public Response intercept(Chain chain) throws IOException {
                            Response response = null;

                            Request request = chain.request();
//                            //拦截指定地址
                            if (request.url().toString().contains("/icp/OFRTZBPA/751504.dow")) {
                                JSONObject jsonObject = new JSONObject();
                                try {
                                    jsonObject.put("RESULT", "00");
                                } catch (JSONException e) {
                                    e.printStackTrace();
                                }
                                Response.Builder builder = new Response.Builder()
                                        .code(200)
                                        .message("")
                                        .request(request)
                                        .protocol(Protocol.HTTP_1_0)
                                        .addHeader("content-type", "application/json");
                                builder.body(ResponseBody.create(MediaType.parse("application/json"), jsonObject.toString().getBytes()));
                                response = builder.build();
                            } else {
                                response = chain.proceed(request);
                            }
                            return response;
                        }
                    }).build();
        } else {
            client = new OkHttpClient.Builder().connectTimeout(TIMEOUT, TimeUnit.SECONDS)
                    .readTimeout(TIMEOUT, TimeUnit.SECONDS).writeTimeout(TIMEOUT, TimeUnit.SECONDS)
                    .sslSocketFactory(SSLSocketUtils.createSSLSocketFactory())
                    .hostnameVerifier(SSLSocketUtils.creatHostnameVerifier())
                    .build();
        }
    }

    public static OkHttpBase getInstantce() {
        if (mOkHttpBase == null) {
            synchronized (OkHttpBase.class) {
                if (mOkHttpBase == null) {
                    mOkHttpBase = new OkHttpBase();
                }
            }
        }
        return mOkHttpBase;
    }
}
```

测试代码：

```
@RunWith(AndroidJUnit4.class)
public class ReissueAcitivityTest {
    @Rule
    public ActivityTestRule<ReissueAcitivity> mActivityRule
            = new ActivityTestRule<>(ReissueAcitivity.class, true, false);

    @Before
    public void setup() {
        OkHttpBase.setFake(true);
    }

    @Test
    public void TestBusiness() throws Exception {
        //模拟要发送的activity
        Context targetContext = InstrumentationRegistry.getInstrumentation().getTargetContext();
        Intent intent = new Intent(targetContext, ReissueAcitivity.class);
        intent.putExtra(UIConstant.INTENT_ORDERID, "12");
        intent.putExtra(UIConstant.INTENT_CUSTNAM, "123");
        intent.putExtra(UIConstant.INTENT_ORDERAMT, "13");
        intent.putExtra(UIConstant.INTENT_IORDERLIST, "");
        intent.putExtra(UIConstant.REISSUE_COME, "formInput");
        //启动目标activity
        mActivityRule.launchActivity(intent);
        onView(withId(R.id.bt_reissue)).perform(click());
        Thread.sleep(30000);
        onView(withId(R.id.dialog_tip_content))
             .check(matches(withText(targetContext.getString(R.string.reissue_success))));
}
```

# 集成测试方案

可参照上面第2点

# jacoco测试覆盖率（含jenkins配置）

单元测试的jacoco本地配置（集成测试配置类似）：

```
apply plugin: 'jacoco'
task jacocoTestReport(type: JacocoReport) {

    group = "Reporting"
    description = "Generate Jacoco coverage reports after running tests."
    reports {
        xml.enabled = true
        html.enabled = true
    }


    def coverageSourceDirs = [
            '../app/src/main/java'
    ]
    sourceDirectories = files(coverageSourceDirs)

    def excludeClasses = ['**/R*.class',
                          '**/*$InjectAdapter.class',
                          '**/*$ModuleAdapter.class',
                          '**/*$ViewInjector*.class',
                          '**/BuildConfig.class'
    ]
    //编译后字节文件地址，看个人的路径是哪个
    //classDirectories = fileTree(dir: '../app/build/intermediates/classes/Test_in/debug', excludes: excludeClasses)
    //包含kotlin和java
      def javaDebugTree = fileTree(dir: "${buildDir}/intermediates/javac/debug/", excludes: fileFilter) //we use "debug" build type for test coverage (can be other)
    def kotlinDebugTree = fileTree(dir: "${buildDir}/tmp/kotlin-classes/debug/", excludes: fileFilter)
    classDirectories = files([javaDebugTree],[kotlinDebugTree]) // we need to target both java and kotlin build folder
 
//    android ec路径
//    executionData = fileTree(dir: project.projectDir, includes:['**/*.exec', '**/*.ec'])
    executionData = files("$buildDir/jacoco/testDebugUnitTest.exec")

    doFirst {
        new File("$buildDir/intermediates/classes/").eachFileRecurse { file ->
            if (file.name.contains('$$')) {
                file.renameTo(file.path.replace('$$', '$'))
            }
        }
    }
}
```

然后运行命令(jenkins也可以直接用这个命令)

```
gradlew jacocoTestReport
```













